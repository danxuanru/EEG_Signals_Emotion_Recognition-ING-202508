# EEG專案程式重構規劃
## 📋 重構概述

**專案名稱**: EEG Signals Emotion Recognition  
**重構時間**: 2025年10月  
**重構目標**: 將單檔腳本架構改為模組化架構，提升代碼可維護性和實驗靈活性  

## 🎯 重構動機

### 原始系統問題分析
1. **架構問題**
   - 單檔腳本設計，功能耦合度高
   - 硬編碼參數，實驗配置不靈活
   - 代碼重複，維護困難

2. **使用問題**
   - 每次實驗需要修改代碼
   - 無法快速切換不同實驗條件
   - 結果管理和比較困難

3. **擴展問題**
   - 新增功能需要大幅修改現有代碼
   - 難以進行批次實驗
   - 無統一的錯誤處理和日誌系統

### 實驗需求
計算不同特徵組合(DE、DE+PSD、DE+PSD+Hjorth)，並將原先30s特徵資料分段切割成前後15s、前中後10s，對其進行二元SVM分類，以觀察特徵組合、時間段對分類準確度的影響。同時也提供逐一去除某頻帶的方法，以觀察是否有哪些頻帶對準確度具有重要性。

若要以現有的程式碼執行，會遇到以下問題:
- 可以使用--session-length參數獲取前15s、前10s的特徵資料，但若是要進行後15s、中後10s的實驗時，則需要到`pkl_to_mat.py`將`data_sub[:, :-2, :sec, :, :]`的sec範圍進行修改。
- 若是要將所有變數迴圈進行實驗，沒有一個整合的系統，需要手動修正執行。
- 後續可能在特徵提取或前處理階段加入、修改其他filter、signal轉換方法，所以需要對其保留彈性。

建立模組化架構需要以實驗需求為主要修改目標!

---

### 步驟1: 分析原程式內容
**做什麼**: 先了解這個專案到底在做什麼  
**為什麼**: 不了解功能就無法重構  

```
我看到的內容:
- 這是一個EEG腦波情緒識別專案
- 使用DE(微分熵)、PSD(功率譜密度)、Hjorth參數做特徵
- 用SVM做分類
- 有二元分類和九類分類兩種模式
```

**思考**: "原來這個系統是要從腦波信號判斷情緒，那我需要保持這個核心功能不變"

### 步驟2: 檢查現有檔案
**做什麼**: 看看現在有哪些Python檔案  
**發現的問題**:
```
- save_de.py: 計算DE特徵，但參數都寫死在檔案裡
- running_norm.py: 做標準化，又是硬編碼參數
- main_de_svm.py: 跑SVM分類，參數也寫死
- plot_result.py: 畫圖，沒有彈性
```

**思考**: "每個檔案都是獨立的，要改實驗參數就得改代碼，太不方便了！"

---

## 🎯 重構規劃 - 第二步：設計新架構

### 步驟3: 思考怎麼解決問題
**問題**: 現在要跑不同實驗，就得改很多檔案的代碼  
**解決思路**: 把參數抽出來，用配置檔案管理

**我的想法**:
```
1. 把所有參數集中管理 → 需要一個配置系統
2. 把功能拆分成獨立模組 → 每個功能一個模組
3. 做一個主控程式 → 串接所有模組
4. 提供簡單的使用方式 → 讓使用者不用懂太多細節
```

### 步驟4: 畫出新架構圖
**我設計的層次**:
```
最上層 (使用者接觸)
├── main_pipeline.py - 主要入口
├── examples.py - 使用範例
└── 命令列工具

中間層 (具體功能)
├── features/ - 特徵提取
├── preprocessing/ - 資料預處理  
├── classification/ - 分類器
└── visualization/ - 視覺化

底層 (基礎建設)
├── core/ - 基礎框架
└── config/ - 配置管理
```

**思考**: "就像蓋房子，先打地基(config, core)，再蓋房間(features, preprocessing等)，最後裝修門面(main_pipeline)"

---

## 🏗️ 底層功能實作

### 步驟5: 實作配置管理系統 (config/)
**目標**: 建立統一的參數管理系統，讓所有實驗參數可以彈性調整

#### 設計思路
```
問題: 要如何管理大量的實驗參數？
思考過程:
1. 參數種類很多：資料路徑、特徵參數、分類器參數
2. 不同實驗需要不同的參數組合
3. 需要能夠快速切換和比較不同配置

解決方案:
→ 使用 dataclass 定義參數結構（有型別檢查）
→ 支援 YAML 檔案載入（方便編輯）
→ 支援程式碼直接創建（方便自動化）
→ 提供預設值（減少配置負擔）
```

#### 實作內容
**檔案結構**:
```
config/
├── __init__.py
├── base_config.py      # 基礎配置類別
├── experiment_config.py # 實驗配置
└── default_configs.py   # 預設配置集合
```

**核心功能**:
1. `BaseConfig`: 所有配置的基礎類別，提供序列化/反序列化
2. `ExperimentConfig`: 實驗配置，包含所有參數
3. 預設配置: 提供常用的配置模板

### 步驟6: 實作核心框架 (core/)
**目標**: 建立可重用的基礎組件，為上層功能提供支援

#### 設計思路
```
問題: 需要哪些基礎功能？
思考過程:
1. 每個功能模組都需要讀寫資料 → 需要統一的資料載入器
2. 實驗過程需要記錄日誌 → 需要日誌系統
3. 可能會有錯誤發生 → 需要錯誤處理機制
4. 需要追蹤實驗結果 → 需要結果管理器

解決方案:
→ DataLoader: 統一的資料載入介面
→ Logger: 結構化的日誌記錄
→ ErrorHandler: 優雅的錯誤處理
→ ResultManager: 實驗結果的保存和載入
```

#### 實作內容
**檔案結構**:
```
core/
├── __init__.py
├── base_module.py      # 基礎模組類別（所有功能模組的父類）
├── data_loader.py      # 資料載入器
├── logger.py           # 日誌系統
└── result_manager.py   # 結果管理
```

**設計原則**:
1. **一致性**: 所有模組繼承自 BaseModule，有統一介面
2. **可擴展**: 使用抽象類別，方便新增功能
3. **錯誤處理**: 每個操作都有適當的錯誤處理
4. **可測試**: 模組間耦合度低，易於測試